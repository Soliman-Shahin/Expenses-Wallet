<ion-content
  class="ion-padding"
  [class.rtl]="currentLang === 'ar'"
  [dir]="currentLang === 'ar' ? 'rtl' : 'ltr'"
  [scrollY]="!isLoading"
  [scrollX]="false"
  [fullscreen]="true"
>
  <!-- Loading State with Skeleton -->
  <ng-container *ngIf="isLoading; else content">
    <div class="skeleton-container ion-padding">
      <app-skeleton-block variant="title"></app-skeleton-block>
      <app-skeleton-block variant="card-md"></app-skeleton-block>
      <app-skeleton-block variant="card-lg"></app-skeleton-block>
      <app-skeleton-block variant="card-xl"></app-skeleton-block>
    </div>
  </ng-container>

  <!-- Main Content -->
  <ng-template #content>
    <!-- Error State -->
    <div *ngIf="state.error()" class="error-state ion-padding ion-text-center">
      <ion-icon name="warning-outline" class="error-icon"></ion-icon>
      <p class="ion-margin-top">{{ state.error() }}</p>
      <ion-button
        fill="clear"
        (click)="retry()"
        [attr.aria-label]="'COMMON.RETRY' | translate"
        class="retry-button"
      >
        <ion-icon slot="start" name="refresh-outline"></ion-icon>
        {{ "COMMON.RETRY" | translate }}
      </ion-button>
    </div>

    <!-- Welcome State -->
    <ng-container *ngIf="!user; else authenticatedView">
      <ion-grid class="welcome-container ion-padding-vertical">
        <ion-row class="ion-justify-content-center ion-align-items-center">
          <ion-col size="12" size-md="10" size-lg="8" class="ion-text-center">
            <div class="welcome-illustration">
              <ion-icon name="wallet-outline" class="welcome-icon"></ion-icon>
              <div class="welcome-dots">
                <span
                  *ngFor="let dot of [1, 2, 3, 4, 5]; trackBy: trackByIndex"
                ></span>
              </div>
            </div>

            <div class="ion-padding-horizontal ion-text-center">
              <h1
                class="welcome-title"
                [attr.aria-label]="'HOME.WELCOME_TITLE' | translate"
              >
                {{ "HOME.WELCOME_TITLE" | translate }}
              </h1>
              <p
                class="welcome-message"
                [attr.aria-label]="'HOME.WELCOME_MESSAGE' | translate"
              >
                {{ "HOME.WELCOME_MESSAGE" | translate }}
              </p>
            </div>

            <div class="welcome-actions ion-padding-horizontal ion-margin-top">
              <ion-button
                routerLink="/auth/login"
                expand="block"
                class="ion-margin-bottom"
                [attr.aria-label]="'AUTH.SIGN_IN' | translate"
                shape="round"
                size="large"
              >
                {{ "AUTH.SIGN_IN" | translate }}
              </ion-button>
              <ion-button
                routerLink="/auth/signup"
                fill="outline"
                expand="block"
                [attr.aria-label]="'AUTH.SIGN_UP' | translate"
                shape="round"
                size="large"
              >
                {{ "AUTH.SIGN_UP" | translate }}
              </ion-button>
            </div>

            <div class="features-preview ion-padding-top">
              <div class="feature-item">
                <ion-icon name="analytics-outline"></ion-icon>
                <span>{{ "HOME.FEATURES.TRACKING" | translate }}</span>
              </div>
              <div class="feature-item">
                <ion-icon name="calendar-outline"></ion-icon>
                <span>{{ "HOME.FEATURES.BUDGETING" | translate }}</span>
              </div>
              <div class="feature-item">
                <ion-icon name="stats-chart-outline"></ion-icon>
                <span>{{ "HOME.FEATURES.INSIGHTS" | translate }}</span>
              </div>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ng-container>

    <!-- Authenticated Content -->
    <ng-template #authenticatedView>
      <ion-grid class="authenticated-content">
        <ng-container *ngIf="vm$ | async as vm">
          <ion-row>
            <ion-col size="12" size-md="10" size-lg="8" class="ion-margin-auto">
              <!-- Welcome Header -->
              <div
                class="welcome-header ion-padding-horizontal ion-padding-bottom"
              >
                <h1 class="greeting">
                  {{ "HOME.GREETING" | translate }},
                  <span class="user-name">{{ displayUsername }}</span>
                </h1>
                <p class="current-date">
                  {{
                    currentDate
                      | date : "EEEE, MMMM d" : undefined : currentLang
                  }}
                </p>
              </div>

              <!-- Month Selector (moved above tabs) -->
              <app-months-scroll-header
                (monthSelected)="onMonthChange($event)"
                (scrolled)="onMonthScroll($event)"
                [selectedDate]="selectedMonth"
                [locale]="currentLang"
                [ngClass]="{
                  'scroll-start': isScrolledToStart,
                  'scroll-end': isScrolledToEnd
                }"
                ariaLabel="{{ 'HOME.SELECT_MONTH' | translate }}"
                class="month-selector"
              ></app-months-scroll-header>

              <!-- Tabs -->
              <ion-segment
                [value]="activeTab"
                (ionChange)="setActiveTab($event.detail.value)"
                class="home-tabs ion-margin-horizontal"
                role="tablist"
                [attr.aria-label]="'HOME.SECTIONS' | translate"
              >
                <ion-segment-button value="summary">
                  <ion-label>{{ "HOME.TABS.SUMMARY" | translate }}</ion-label>
                </ion-segment-button>
                <ion-segment-button value="charts">
                  <ion-label>{{ "HOME.TABS.CHARTS" | translate }}</ion-label>
                </ion-segment-button>
              </ion-segment>

              <!-- Summary skeleton template used across summary sections -->
              <ng-template #summarySkeleton>
                <div class="skeleton-container">
                  <app-skeleton-block variant="line"></app-skeleton-block>
                  <app-skeleton-block variant="card-sm"></app-skeleton-block>
                </div>
              </ng-template>

              <!-- Charts Section (tab: charts) -->
              <ng-container *ngIf="activeTab === 'charts'">
                <section
                  class="card-section charts-card ion-margin-vertical"
                  role="region"
                  aria-live="polite"
                  [attr.aria-label]="'HOME.CHARTS' | translate"
                >
                  <app-section-header
                    icon="analytics-outline"
                    [title]="'HOME.CHARTS' | translate"
                  ></app-section-header>

                  <ng-container
                    *ngIf="!isDashboardLoading; else chartsSkeleton"
                  >
                    <!-- Income vs Expenses Bar Chart -->
                    <app-bar-chart
                      *ngIf="vm.incomeVsExpense.length > 0"
                      [data]="vm.incomeVsExpense"
                      [title]="'HOME.INCOME_VS_EXPENSES' | translate"
                      [ariaLabel]="'HOME.INCOME_VS_EXPENSES_CHART' | translate"
                      [chartDescription]="
                        'HOME.INCOME_VS_EXPENSES_DESC' | translate
                      "
                    ></app-bar-chart>

                    <!-- Expense by Category Pie Chart -->
                    <app-pie-chart
                      *ngIf="vm.expenseByCategory.length > 0"
                      [data]="vm.expenseByCategory"
                      [title]="'HOME.EXPENSE_BY_CATEGORY' | translate"
                      [ariaLabel]="'HOME.EXPENSE_BY_CATEGORY_CHART' | translate"
                      [showLegend]="true"
                      [size]="300"
                    ></app-pie-chart>

                    <!-- Monthly Expenses Line Chart -->
                    <app-line-chart
                      *ngIf="vm.monthlyExpenses.length > 0"
                      [data]="vm.monthlyExpenses"
                      [title]="'HOME.MONTHLY_EXPENSES' | translate"
                      [ariaLabel]="'HOME.MONTHLY_EXPENSES_CHART' | translate"
                      [chartDescription]="
                        'HOME.MONTHLY_EXPENSES_DESC' | translate
                      "
                    ></app-line-chart>
                  </ng-container>
                  <ng-template #chartsSkeleton>
                    <div class="chart-skeleton ion-margin-vertical">
                      <app-skeleton-block variant="chart"></app-skeleton-block>
                      <app-skeleton-block variant="chart"></app-skeleton-block>
                      <app-skeleton-block variant="chart"></app-skeleton-block>
                    </div>
                  </ng-template>
                </section>
              </ng-container>

              <!-- Summary Section (tab: summary) -->
              <ng-container *ngIf="activeTab === 'summary'">
                <!-- Balance Summary -->
                <section
                  class="card-section transactions-card ion-margin-vertical"
                  role="region"
                  aria-live="polite"
                  [attr.aria-label]="'HOME.BALANCE_SUMMARY' | translate"
                >
                  <app-section-header
                    icon="wallet-outline"
                    [title]="'HOME.BALANCE_SUMMARY' | translate"
                  ></app-section-header>
                  <ng-container
                    *ngIf="!isDashboardLoading; else summarySkeleton"
                  >
                    <app-balance-card
                      [balance]="vm.totals.balance"
                      [income]="vm.totals.income"
                      [expenses]="vm.totals.expenses"
                      [percentageChange]="percentageChange"
                      [isLoading]="isDashboardLoading"
                      [currency]="vm.currency || currency"
                      role="group"
                      attr.aria-label="{{ 'HOME.BALANCE_SUMMARY' | translate }}"
                      (mouseenter)="onCardHover('balance', true)"
                      (mouseleave)="onCardHover('balance', false)"
                      (click)="onCardClick('balance')"
                      [class.interact]="cardStates['balance']"
                    >
                    </app-balance-card>
                  </ng-container>
                </section>

                <!-- Recent Transactions -->
                <section
                  class="card-section transactions-card ion-margin-vertical"
                  role="region"
                  aria-live="polite"
                  [attr.aria-label]="'TRANSACTIONS.RECENT' | translate"
                >
                  <app-section-header
                    icon="list-outline"
                    [title]="'TRANSACTIONS.RECENT' | translate"
                    [ctaText]="'COMMON.VIEW_ALL' | translate"
                    ctaIcon="arrow-forward"
                    [ctaRouterLink]="'/transactions'"
                  ></app-section-header>
                  <app-transactions
                    [limit]="5"
                    [month]="selectedMonth.month"
                    [year]="selectedMonth.year"
                  ></app-transactions>
                </section>
              </ng-container>
            </ion-col>
          </ion-row>
        </ng-container>
      </ion-grid>
    </ng-template>
  </ng-template>
  <ion-fab
    vertical="bottom"
    horizontal="end"
    slot="fixed"
    (mouseenter)="onCardHover('quickActions', true)"
    (mouseleave)="onCardHover('quickActions', false)"
    (click)="onCardClick('quickActions')"
    [class.interact]="cardStates['quickActions']"
  >
    <ion-fab-button
      (click)="openExpenseModal()"
      [attr.aria-label]="'COMMON.ADD_EXPENSE' | translate"
      [title]="'COMMON.ADD_EXPENSE' | translate"
    >
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
